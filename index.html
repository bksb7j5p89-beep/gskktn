<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Chất lượng Không khí</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/vi.min.js"></script>

    <style>
        :root {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 700;
        }

        /* --- CONTAINER CHÍNH --- */
        .dashboard-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- HÀNG 1: AQI (Trái) + 4 Widget nhỏ (Phải) --- */
        .top-section {
            display: grid;
            grid-template-columns: 1.5fr 1fr; /* Bên trái lớn hơn bên phải chút */
            gap: 20px;
        }

        /* Card chung */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* --- AQI GAUGE (Bên trái) --- */
        .aqi-card {
            aspect-ratio: 16/9; /* Khoá tỷ lệ khung AQI */
            justify-content: space-between;
            padding-bottom: 30px;
        }

        .chart-wrapper-gauge {
            position: relative;
            width: 90%;
            height: 80%; /* Dành không gian cho biểu đồ */
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Đẩy biểu đồ xuống đáy của vùng chứa */
        }

        .aqi-info {
            text-align: center;
            margin-top: -30px; /* Kéo số liệu lên gần kim hơn */
            z-index: 10;
        }

        .aqi-number {
            font-size: 4rem;
            font-weight: 800;
            line-height: 1;
            display: block;
        }

        .aqi-status {
            font-size: 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 5px;
            display: block;
        }

        .aqi-label-title {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* --- 4 WIDGET NHỎ (Bên phải) --- */
        .widgets-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
        }

        .mini-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 4/3; /* Khoá tỷ lệ các thẻ nhỏ */
        }

        .mini-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .mini-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .mini-unit {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Màu sắc chỉ số */
        .text-temp { color: #f59e0b; }
        .text-humi { color: #3b82f6; }
        .text-pm { color: #10b981; }
        .text-co { color: #ef4444; }

        /* --- HÀNG 2: 4 BIỂU ĐỒ (Charts) --- */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 cột */
            gap: 20px;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 15px;
            aspect-ratio: 16/9; /* Khoá tỷ lệ đồ thị */
            position: relative;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chart-container-inner {
            position: relative;
            height: 85%;
            width: 100%;
        }

        /* --- FOOTER --- */
        .footer-info {
            margin-top: 30px;
            text-align: center;
            color: #888;
            font-size: 0.9rem;
            font-style: italic;
        }

        /* RESPONSIVE: Mobile */
        @media (max-width: 768px) {
            .top-section {
                grid-template-columns: 1fr; /* Chuyển thành 1 cột */
            }
            .charts-section {
                grid-template-columns: 1fr; /* Đồ thị xếp dọc */
            }
            .aqi-card {
                aspect-ratio: auto;
                height: 300px;
            }
            .mini-card {
                aspect-ratio: auto;
                height: 120px;
            }
        }
    </style>
</head>
<body>

    <h1>Phòng Khách</h1>

    <div class="dashboard-container">
        
        <div class="top-section">
            <div class="card aqi-card">
                <div class="aqi-label-title">Chỉ số AQI</div>
                <div class="chart-wrapper-gauge">
                    <canvas id="aqiGauge"></canvas>
                </div>
                <div class="aqi-info">
                    <span id="aqi-val" class="aqi-number">--</span>
                    <span id="aqi-text" class="aqi-status">--</span>
                </div>
            </div>

            <div class="widgets-grid">
                <div class="mini-card">
                    <div class="mini-label">Nhiệt độ</div>
                    <div class="mini-value text-temp">
                        <span id="temp-val">--</span><span class="mini-unit">°C</span>
                    </div>
                </div>
                <div class="mini-card">
                    <div class="mini-label">Độ ẩm</div>
                    <div class="mini-value text-humi">
                        <span id="humi-val">--</span><span class="mini-unit">%</span>
                    </div>
                </div>
                <div class="mini-card">
                    <div class="mini-label">Bụi PM2.5</div>
                    <div class="mini-value text-pm">
                        <span id="pm-val">--</span><span class="mini-unit">µg/m³</span>
                    </div>
                </div>
                <div class="mini-card">
                    <div class="mini-label">Khí CO</div>
                    <div class="mini-value text-co">
                        <span id="co-val">--</span><span class="mini-unit">ppm</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-title"><span style="color:#f59e0b">●</span> Diễn biến Nhiệt độ (°C)</div>
                <div class="chart-container-inner"><canvas id="chartTemp"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-title"><span style="color:#3b82f6">●</span> Diễn biến Độ ẩm (%)</div>
                <div class="chart-container-inner"><canvas id="chartHumi"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-title"><span style="color:#10b981">●</span> Diễn biến Bụi PM2.5</div>
                <div class="chart-container-inner"><canvas id="chartPM"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-title"><span style="color:#ef4444">●</span> Diễn biến Khí CO</div>
                <div class="chart-container-inner"><canvas id="chartCO"></canvas></div>
            </div>
        </div>

    </div>

    <div class="footer-info" id="global-update-time">
        Đang tải dữ liệu...
    </div>

    <script>
        // ================================================================
        // CẤU HÌNH (THAY ĐỔI THÔNG TIN CỦA BẠN TẠI ĐÂY)
        // ================================================================
        const CHANNEL_ID = '0000000';      // <-- Thay ID kênh của bạn
        const READ_API_KEY = 'XXXXXXXX';  // <-- Thay Read Key (nếu kênh private)
        // ================================================================

        // Mapping Field (Dựa trên code Arduino)
        const FIELDS = { aqi: 'field1', pm: 'field2', co: 'field3', temp: 'field4', humi: 'field5' };

        let gaugeChart;
        let charts = {}; // Lưu trữ 4 biểu đồ

        // --- 1. CẤU HÌNH GAUGE (AQI) ---
        function initGauge() {
            const ctx = document.getElementById('aqiGauge').getContext('2d');
            gaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    // Chia đều 6 phần để màu sắc cân bằng trực quan
                    labels: ['Tốt', 'Trung bình', 'Kém', 'Xấu', 'Rất xấu', 'Nguy hại'],
                    datasets: [{
                        data: [1, 1, 1, 1, 1, 1], // Mỗi phần bằng nhau về mặt hình ảnh
                        backgroundColor: [
                            '#00E400', // Tốt (Green)
                            '#FFFF00', // TB (Yellow)
                            '#FF7E00', // Kém (Orange)
                            '#FF0000', // Xấu (Red)
                            '#8F3F97', // Rất xấu (Purple)
                            '#7E0023'  // Nguy hại (Maroon)
                        ],
                        borderWidth: 2,
                        borderColor: '#fff',
                        hoverOffset: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    rotation: -90,      
                    circumference: 180, 
                    cutout: '85%',      // Vòng tròn mỏng hơn cho đẹp
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                },
                plugins: [{
                    id: 'needle',
                    afterDatasetDraw: function(chart) {
                        const { ctx, width, height } = chart;
                        let aqiVal = parseInt(document.getElementById('aqi-val').innerText) || 0;
                        if(aqiVal < 0) aqiVal = 0;
                        if(aqiVal > 500) aqiVal = 500;

                        // Tính góc kim: Map giá trị 0-500 sang góc 0-180 (Pi)
                        // Công thức: (Value / Max) * PI
                        const angle = Math.PI + (aqiVal / 500) * Math.PI;

                        const cx = width / 2;
                        const cy = height - (height * 0.15); // Tâm xoay

                        ctx.save();
                        ctx.translate(cx, cy);
                        ctx.rotate(angle);
                        
                        // Vẽ kim
                        ctx.beginPath();
                        ctx.moveTo(0, -5);
                        ctx.lineTo(height / 1.8, 0); // Chiều dài kim
                        ctx.lineTo(0, 5);
                        ctx.fillStyle = '#374151';
                        ctx.fill();
                        
                        // Vẽ chốt kim
                        ctx.beginPath();
                        ctx.arc(0, 0, 8, 0, Math.PI * 2);
                        ctx.fillStyle = '#374151';
                        ctx.fill();
                        ctx.restore();
                    }
                }]
            });
        }

        // --- 2. CẤU HÌNH CHART NHỎ (4 Charts) ---
        function createLineChart(canvasId, color, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: label,
                        data: [],
                        borderColor: color,
                        backgroundColor: color + '20', // Màu nền nhạt (Hex + Opacity)
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4, // Đường cong mềm mại
                        pointRadius: 0, // Ẩn điểm để đồ thị sạch hơn
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false }, // Ẩn trục X cho gọn
                        y: { 
                            beginAtZero: false,
                            grid: { color: '#f3f4f6' },
                            ticks: { font: { size: 10 } }
                        }
                    },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }

        function initCharts() {
            charts.temp = createLineChart('chartTemp', '#f59e0b', 'Nhiệt độ');
            charts.humi = createLineChart('chartHumi', '#3b82f6', 'Độ ẩm');
            charts.pm   = createLineChart('chartPM',   '#10b981', 'Bụi PM2.5');
            charts.co   = createLineChart('chartCO',   '#ef4444', 'Khí CO');
        }

        // --- 3. XỬ LÝ DỮ LIỆU ---
        function updateAqiDisplay(aqi) {
            const elText = document.getElementById('aqi-text');
            const elVal = document.getElementById('aqi-val');
            
            elVal.innerText = aqi;
            
            let status = "", color = "";
            if (aqi <= 50) { status = "Tốt"; color = "#00E400"; }
            else if (aqi <= 100) { status = "Trung bình"; color = "#CCCC00"; }
            else if (aqi <= 150) { status = "Kém"; color = "#FF7E00"; }
            else if (aqi <= 200) { status = "Xấu"; color = "#FF0000"; }
            else if (aqi <= 300) { status = "Rất xấu"; color = "#8F3F97"; }
            else { status = "Nguy hại"; color = "#7E0023"; }

            elText.innerText = status;
            elText.style.color = color;
            
            if(gaugeChart) gaugeChart.update();
        }

        async function fetchData() {
            const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=20&timezone=Asia/Ho_Chi_Minh`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if(!data.feeds.length) return;

                const last = data.feeds[data.feeds.length - 1];

                // Update Widget Số
                updateAqiDisplay(Math.round(last[FIELDS.aqi] || 0));
                document.getElementById('temp-val').innerText = Math.round(last[FIELDS.temp] || 0);
                document.getElementById('humi-val').innerText = Math.round(last[FIELDS.humi] || 0);
                document.getElementById('pm-val').innerText = parseFloat(last[FIELDS.pm] || 0).toFixed(1);
                document.getElementById('co-val').innerText = parseFloat(last[FIELDS.co] || 0).toFixed(1);

                // Update Footer Time
                moment.locale('vi');
                const timeAgo = moment(last.created_at).fromNow();
                document.getElementById('global-update-time').innerText = `Cập nhật dữ liệu lần cuối: ${timeAgo} (${moment(last.created_at).format('HH:mm:ss DD/MM')})`;

                // Update Charts
                const labels = data.feeds.map(f => moment(f.created_at).format('HH:mm'));
                
                charts.temp.data.labels = labels;
                charts.temp.data.datasets[0].data = data.feeds.map(f => f[FIELDS.temp]);
                charts.temp.update();

                charts.humi.data.labels = labels;
                charts.humi.data.datasets[0].data = data.feeds.map(f => f[FIELDS.humi]);
                charts.humi.update();

                charts.pm.data.labels = labels;
                charts.pm.data.datasets[0].data = data.feeds.map(f => f[FIELDS.pm]);
                charts.pm.update();

                charts.co.data.labels = labels;
                charts.co.data.datasets[0].data = data.feeds.map(f => f[FIELDS.co]);
                charts.co.update();

            } catch(e) {
                console.error(e);
            }
        }

        window.onload = () => {
            initGauge();
            initCharts();
            fetchData();
            setInterval(fetchData, 20000); // 20s refresh
        };
    </script>
</body>
</html>
