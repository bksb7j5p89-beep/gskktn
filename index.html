<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn Ph√≤ng Kh√°ch</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/vi.min.js"></script>

    <style>
        * { box-sizing: border-box; }

        :root {
            --bg-body: #f8fafc; --bg-card: #ffffff; --text-main: #1e293b; --text-sub: #64748b;
            --radius: 24px; --shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -4px rgba(0,0,0,0.025);
            --aqi-height: 460px; --chart-height: 340px; --fixed-width: 1500px;
            --primary-green: #10b981;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 40px; min-width: var(--fixed-width); overflow-x: auto; }
        .container { width: var(--fixed-width); margin: 0 auto; position: relative; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { margin: 0; font-size: 32px; font-weight: 800; color: #0f172a; }
        .status-badge { background: #fff; padding: 10px 20px; border-radius: 99px; box-shadow: var(--shadow); font-size: 1rem; font-weight: 600; color: var(--text-sub); display: flex; align-items: center; gap: 10px; border: 1px solid #e2e8f0; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.ok { background: #10b981; animation: pulse 2s infinite; } 
        .dot.err { background: #ef4444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* MAIN GRID */
        .main-grid { display: grid; grid-template-columns: 1fr var(--aqi-height); gap: 24px; align-items: start; }
        .left-col { display: flex; flex-direction: column; gap: 24px; }

        /* AQI CARD */
        .aqi-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 0; position: relative; height: var(--aqi-height); display: flex; flex-direction: column; overflow: hidden; }
        .card-label { font-size: 1.2rem; font-weight: 700; color: var(--text-sub); position: absolute; top: 20px; left: 25px; z-index: 10; }
        .gauge-section { flex: 6; position: relative; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; width: 100%; }
        .gauge-wrapper { position: relative; width: 90%; height: 100%; }
        .info-section { flex: 4; display: flex; flex-direction: row; border-top: 1px solid #f1f5f9; }
        .aqi-value-box { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; border-right: 1px solid #f1f5f9; background: #f8fafc50; }
        .aqi-number { font-size: 5.5rem; font-weight: 900; line-height: 1; color: #1e293b; letter-spacing: -2px; }
        .aqi-sub-label { font-size: 0.9rem; font-weight: 600; color: #94a3b8; margin-top: 5px; }
        .aqi-status-box { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .aqi-status-text { font-size: 2.2rem; font-weight: 800; text-transform: uppercase; margin: 0; line-height: 1.2; text-align: center; transition: color 0.3s ease; }
        .aqi-status-label { font-size: 0.9rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; }

        /* CHARTS */
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .chart-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 24px; height: var(--chart-height); display: flex; flex-direction: column; border: 1px solid #f1f5f9; }
        .chart-header { font-size: 1rem; font-weight: 700; color: var(--text-sub); display: flex; align-items: center; gap: 8px; margin-bottom: 15px; }
        .chart-body { flex-grow: 1; position: relative; width: 100%; }

        /* RIGHT COLUMN */
        .right-column-container { display: flex; flex-direction: column; gap: 24px; }
        .right-col-grid { height: var(--aqi-height); display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 20px; }
        .widget { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 15px; border: 1px solid #f1f5f9; aspect-ratio: 1/1; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .widget:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border-color: var(--primary-green); }
        .w-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .w-label { font-size: 0.9rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        .w-val { font-size: 2.8rem; font-weight: 800; margin: 5px 0; letter-spacing: -1px; color: #334155; }
        .w-unit { font-size: 1rem; font-weight: 600; color: #94a3b8; }
        .c-temp { color: #f59e0b; } .c-humi { color: #3b82f6; } .c-pm { color: #10b981; } .c-co { color: #ef4444; }

        /* CONTROL HUB */
        .control-hub { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); height: var(--chart-height); display: flex; flex-direction: column; overflow: hidden; border: 1px solid #f1f5f9; }
        .hub-header { flex: 35; display: flex; border-bottom: 1px solid #e2e8f0; padding: 5px 0; }
        .hub-cell { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hub-cell.separator { border-right: 1px solid #e2e8f0; }
        .time-display { font-size: 3.2rem; font-weight: 900; color: #1e293b; line-height: 1; letter-spacing: -2px; }
        .date-day { font-size: 0.9rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }
        .date-full { font-size: 1.4rem; font-weight: 800; color: #334155; letter-spacing: -0.5px; }
        .hub-buttons { flex: 65; display: flex; gap: 20px; padding: 20px; background: #f8fafc; }
        
        /* Button Styles */
        .ctrl-btn { flex: 1; background: #ffffff; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; user-select: none; }
        .ctrl-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .ctrl-btn:active { transform: scale(0.98); }
        .btn-icon-circle { width: 55px; height: 55px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 10px; transition: 0.3s; }
        .btn-label { font-size: 1.1rem; font-weight: 800; color: #475569; }
        .btn-status { font-size: 0.9rem; font-weight: 700; color: #94a3b8; margin-top: 5px; text-transform: uppercase; }
        .btn-real-status { font-size: 0.75rem; font-weight: 600; color: #64748b; margin-top: 2px; }

        /* Button States */
        .ctrl-btn.auto-mode { border-color: #e2e8f0; background: #ffffff; }
        .ctrl-btn.auto-mode .btn-icon-circle { background: #f1f5f9; color: #334155; }
        .ctrl-btn.auto-active { border-color: var(--primary-green); background: #f0fdf4; }
        .ctrl-btn.auto-active .btn-icon-circle { background: #d1fae5; color: var(--primary-green); }
        .ctrl-btn.auto-active .btn-status { color: var(--primary-green); font-weight: 800; }
        .ctrl-btn.manual-on { border-color: var(--primary-green); background: #dcfce7; }
        .ctrl-btn.manual-on .btn-icon-circle { background: var(--primary-green); color: #fff; }
        .ctrl-btn.manual-on .btn-label { color: #065f46; }
        .ctrl-btn.manual-on .btn-status { color: var(--primary-green); }
        .ctrl-btn.manual-off { border-color: #ef4444; background: #fff5f5; }
        .ctrl-btn.manual-off .btn-icon-circle { background: #fee2e2; color: #ef4444; }
        .ctrl-btn.manual-off .btn-label { color: #991b1b; }
        .ctrl-btn.manual-off .btn-status { color: #ef4444; }

        /* INSIGHT CARD */
        .insight-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: var(--radius); box-shadow: var(--shadow); height: var(--chart-height); padding: 30px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; text-align: center; position: relative; overflow: hidden; }
        .insight-card::before { content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%; }
        .insight-card::after { content: ''; position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 50%; }
        .insight-icon { font-size: 4.5rem; margin-bottom: 15px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .insight-title { font-size: 1rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
        .insight-status { font-size: 2.8rem; font-weight: 900; margin-bottom: 15px; line-height: 1.1; }
        .insight-desc { font-size: 1.1rem; line-height: 1.5; color: #cbd5e1; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 12px; font-weight: 500; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); z-index: 999; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-content { background: #fff; width: 800px; max-width: 90%; border-radius: 32px; padding: 40px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .m-title-group { display: flex; flex-direction: column; }
        .m-title { font-size: 1.5rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
        .m-value-big { font-size: 5rem; font-weight: 900; color: #1e293b; line-height: 1; margin-top: 5px; }
        .m-unit { font-size: 1.5rem; font-weight: 600; color: #94a3b8; }
        .btn-back { background: #f1f5f9; border: none; padding: 12px 24px; border-radius: 99px; font-size: 1rem; font-weight: 700; color: #475569; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-back:hover { background: #e2e8f0; color: #1e293b; }
        
        .modal-body { display: grid; grid-template-columns: 1fr 1.5fr; gap: 40px; }
        .stat-box { background: #f8fafc; border-radius: 24px; padding: 30px; display: flex; flex-direction: column; justify-content: center; gap: 20px; }
        .stat-row { display: flex; justify-content: space-between; align-items: baseline; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
        .stat-row:last-child { border-bottom: none; padding-bottom: 0; }
        .stat-label { font-size: 1.1rem; font-weight: 600; color: #64748b; }
        .stat-val { font-size: 2rem; font-weight: 800; color: #334155; }

        /* TABLE STYLE (NEW) */
        .table-section { background: #fff; border: 1px solid #f1f5f9; border-radius: 24px; padding: 25px; display: flex; flex-direction: column; }
        .section-title { font-size: 1rem; font-weight: 700; color: #94a3b8; margin-bottom: 15px; display: block; text-transform: uppercase; }
        .weekly-table { width: 100%; border-collapse: collapse; }
        .weekly-table th { text-align: left; color: #64748b; font-weight: 600; padding: 10px; border-bottom: 2px solid #e2e8f0; }
        .weekly-table td { padding: 12px 10px; font-weight: 700; color: #334155; border-bottom: 1px solid #f1f5f9; }
        .weekly-table tr:last-child td { border-bottom: none; }
        .weekly-table tr:nth-child(even) { background-color: #f8fafc; }
        .diff-tag { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; margin-left: 10px; }
        .diff-up { background: #fee2e2; color: #ef4444; }
        .diff-down { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Ph√≤ng Kh√°ch</h1>
        <div class="status-badge"><div id="led" class="dot ok"></div><span id="status">ƒêang k·∫øt n·ªëi...</span></div>
    </div>

    <div class="main-grid">
        <div class="left-col">
            <div class="aqi-card">
                <div class="card-label">AIR QUALITY INDEX</div>
                <div class="gauge-section"><div class="gauge-wrapper"><canvas id="gaugeCanvas"></canvas></div></div>
                <div class="info-section">
                    <div class="aqi-value-box"><div class="aqi-sub-label">Gi√° tr·ªã hi·ªán t·∫°i</div><div id="aqi-val" class="aqi-number">--</div></div>
                    <div class="aqi-status-box"><div class="aqi-status-label">Ch·∫•t l∆∞·ª£ng</div><div id="aqi-text" class="aqi-status-text">--</div></div>
                </div>
            </div>
            <div class="charts-container">
                <div class="chart-card"><div class="chart-header"><span style="color:#f59e0b">‚óè</span> L·ªãch s·ª≠ Nhi·ªát ƒë·ªô</div><div class="chart-body"><canvas id="cTemp"></canvas></div></div>
                <div class="chart-card"><div class="chart-header"><span style="color:#3b82f6">‚óè</span> L·ªãch s·ª≠ ƒê·ªô ·∫©m</div><div class="chart-body"><canvas id="cHumi"></canvas></div></div>
                <div class="chart-card"><div class="chart-header"><span style="color:#10b981">‚óè</span> L·ªãch s·ª≠ B·ª•i PM2.5</div><div class="chart-body"><canvas id="cPM"></canvas></div></div>
                <div class="chart-card"><div class="chart-header"><span style="color:#ef4444">‚óè</span> L·ªãch s·ª≠ Kh√≠ CO</div><div class="chart-body"><canvas id="cCO"></canvas></div></div>
            </div>
        </div>

        <div class="right-column-container">
            <div class="right-col-grid">
                <div class="widget" onclick="openDetail('temp')"><div class="w-icon">üå°Ô∏è</div><div class="w-label">Nhi·ªát ƒë·ªô</div><div class="w-val c-temp" id="v-temp">--</div><div class="w-unit">¬∞C</div></div>
                <div class="widget" onclick="openDetail('humi')"><div class="w-icon">üíß</div><div class="w-label">ƒê·ªô ·∫©m</div><div class="w-val c-humi" id="v-humi">--</div><div class="w-unit">%</div></div>
                <div class="widget" onclick="openDetail('pm')"><div class="w-icon">üå´Ô∏è</div><div class="w-label">B·ª•i PM2.5</div><div class="w-val c-pm" id="v-pm">--</div><div class="w-unit">¬µg/m¬≥</div></div>
                <div class="widget" onclick="openDetail('co')"><div class="w-icon">üè≠</div><div class="w-label">Kh√≠ CO</div><div class="w-val c-co" id="v-co">--</div><div class="w-unit">ppm</div></div>
            </div>

            <div class="control-hub">
                <div class="hub-header">
                    <div class="hub-cell separator"><div class="time-display" id="clock-time">--:--</div></div>
                    <div class="hub-cell"><div class="date-day" id="clock-day">--</div><div class="date-full" id="clock-date">--/--/----</div></div>
                </div>
                <div class="hub-buttons">
                    <div class="ctrl-btn auto-mode" id="btn-ac" onclick="toggleBtn('btn-ac')">
                        <div class="btn-icon-circle">‚ùÑÔ∏è</div><div class="btn-label">ƒêi·ªÅu Ho√†</div><div class="btn-status">AUTO</div><div class="btn-real-status" id="real-ac">(--)</div>
                    </div>
                    <div class="ctrl-btn auto-mode" id="btn-fresh" onclick="toggleBtn('btn-fresh')">
                        <div class="btn-icon-circle">üçÉ</div><div class="btn-label">Kh√≠ T∆∞∆°i</div><div class="btn-status">AUTO</div><div class="btn-real-status" id="real-fan">(--)</div>
                    </div>
                </div>
            </div>

            <div class="insight-card">
                <div class="insight-title">M·ª©c ƒë·ªô ti·ªán nghi</div>
                <div class="insight-icon" id="insight-icon">üòä</div>
                <div class="insight-status" id="insight-status">--</div>
                <div class="insight-desc" id="insight-msg">ƒêang ph√¢n t√≠ch...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="m-title-group"><div class="m-title" id="m-title">Nhi·ªát ƒë·ªô</div><div class="m-value-big"><span id="m-val">--</span> <span class="m-unit" id="m-unit">¬∞C</span></div></div>
            <button class="btn-back" onclick="closeDetail()">‚¨Ö Quay l·∫°i</button>
        </div>
        <div class="modal-body">
            <div class="stat-box">
                <div class="stat-row"><div class="stat-label">Th·∫•p nh·∫•t h√¥m nay</div><div class="stat-val" style="color:#3b82f6" id="m-min">--</div></div>
                <div class="stat-row"><div class="stat-label">Cao nh·∫•t h√¥m nay</div><div class="stat-val" style="color:#ef4444" id="m-max">--</div></div>
            </div>
            <div class="table-section">
                <span class="section-title">L·ªäCH S·ª¨ 7 NG√ÄY (Trung b√¨nh)</span>
                <table class="weekly-table" id="weeklyTable">
                    </table>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        ID: '3195067',
        READ_KEY: '5NY52VK6EWBE41LC', 
        WRITE_KEY: 'H0ARO2KSFH415ZDX', 
        MAP: { aqi: 'field1', pm: 'field2', co: 'field3', temp: 'field4', humi: 'field5' }
    };

    let charts = {}; let gauge; let globalFeeds = [];
    let ctrlMode = { ac: 0, fan: 0 }; 
    let realState = { ac: 0, fan: 0 }; 

    /* --- GAUGE CONFIG (ƒê√É CH·ªàNH NG·∫ÆN KIM & V·ªä TR√ç S·ªê) --- */
    const AQI_COLORS = ['#4ade80', '#facc15', '#fb923c', '#ef4444', '#a855f7', '#881337'];
    function getColorForAQI(aqi) { if (aqi <= 50) return AQI_COLORS[0]; if (aqi <= 100) return AQI_COLORS[1]; if (aqi <= 150) return AQI_COLORS[2]; if (aqi <= 200) return AQI_COLORS[3]; if (aqi <= 300) return AQI_COLORS[4]; return AQI_COLORS[5]; }
    function getTextForAQI(aqi) { if (aqi <= 50) return "T·ªët"; if (aqi <= 100) return "Trung b√¨nh"; if (aqi <= 150) return "K√©m"; if (aqi <= 200) return "X·∫•u"; if (aqi <= 300) return "R·∫•t x·∫•u"; return "Nguy h·∫°i"; }
    
    function calculateNeedleAngle(aqi) { const segment = Math.PI / 6; let angle = 0; if (aqi <= 50) angle = (aqi / 50) * segment; else if (aqi <= 100) angle = segment + ((aqi - 50) / 50) * segment; else if (aqi <= 150) angle = segment * 2 + ((aqi - 100) / 50) * segment; else if (aqi <= 200) angle = segment * 3 + ((aqi - 150) / 50) * segment; else if (aqi <= 300) angle = segment * 4 + ((aqi - 200) / 100) * segment; else { let val = Math.min(aqi, 500); angle = segment * 5 + ((val - 300) / 200) * segment; } return Math.PI + angle; }
    
    const gaugePlugin = { id: 'gaugeLabels', afterDraw: (chart) => { 
        const { ctx, width, height } = chart; const meta = chart.getDatasetMeta(0); 
        const cx = meta.data[0].x; const cy = meta.data[0].y; const outerR = meta.data[0].outerRadius; 
        
        let val = parseInt(document.getElementById('aqi-val').innerText) || 0; 
        const angle = calculateNeedleAngle(val); 
        
        // --- 1. L√ÄM NG·∫ÆN KIM L·∫†I ---
        const needleLen = outerR - 45; // Ng·∫Øn h∆°n tr∆∞·ªõc (c≈© l√† -5)

        ctx.save(); ctx.translate(cx, cy); ctx.rotate(angle); 
        ctx.beginPath(); ctx.moveTo(0, -6); ctx.lineTo(needleLen, 0); ctx.lineTo(0, 6); 
        ctx.fillStyle = '#1e293b'; ctx.fill(); 
        ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI * 2); ctx.fillStyle = '#1e293b'; ctx.fill(); 
        ctx.beginPath(); ctx.arc(0, 0, 4, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill(); ctx.restore(); 
        
        // --- 2. CƒÇN CH·ªàNH V·ªä TR√ç S·ªê ---
        const numbers = [0, 50, 100, 150, 200, 300, 500]; 
        const segmentAngle = Math.PI / 6; 
        ctx.font = '700 15px Inter'; ctx.fillStyle = '#64748b'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; 
        
        // M·∫£ng offset (r: kho·∫£ng c√°ch t·ª´ t√¢m, y: ƒëi·ªÅu ch·ªânh d·ªçc) - ƒê√É C√ÇN CH·ªàNH K·ª∏
        const manualOffsets = [
            { r: 30, y: 0 },   // 0: N√¢ng l√™n ngang ch·ªët
            { r: 24, y: 5 },   // 50
            { r: 18, y: 15 },  // 100
            { r: 10, y: 25 },  // 150 (ƒê·ªânh)
            { r: 18, y: 15 },  // 200
            { r: 24, y: 5 },   // 300
            { r: 30, y: 0 }    // 500: N√¢ng l√™n ngang ch·ªët
        ]; 
        
        numbers.forEach((num, i) => { 
            const numAngle = Math.PI + (i * segmentAngle); 
            const offset = manualOffsets[i]; 
            const rNum = outerR + offset.r; // B√°n k√≠nh
            const nx = cx + Math.cos(numAngle) * rNum; 
            const ny = cy + Math.sin(numAngle) * rNum + offset.y; 
            ctx.fillText(num, nx, ny); 
        }); 
    }};

    const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: true, ticks: { maxTicksLimit: 4, font: {size: 11} }, grid: { borderDash: [4, 4], color: '#f3f4f6' } } }, elements: { point: { radius: 0, hitRadius: 10 }, line: { borderWidth: 2.5, tension: 0.4 } } };

    function init() { 
        const ctxG = document.getElementById('gaugeCanvas').getContext('2d'); 
        gauge = new Chart(ctxG, { type: 'doughnut', data: { labels: [], datasets: [{ data: [1, 1, 1, 1, 1, 1], backgroundColor: AQI_COLORS, borderColor: '#ffffff', borderWidth: 2, cutout: '60%', circumference: 180, rotation: -90 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, layout: { padding: { top: 25, left: 30, right: 30, bottom: 0 } } }, plugins: [gaugePlugin] }); 
        const mkChart = (id, color) => new Chart(document.getElementById(id), { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: color, backgroundColor: color+'10', fill: true }] }, options: commonOptions }); 
        charts.temp = mkChart('cTemp', '#f59e0b'); charts.humi = mkChart('cHumi', '#3b82f6'); charts.pm = mkChart('cPM', '#10b981'); charts.co = mkChart('cCO', '#ef4444'); 
        fetchData(); setInterval(fetchData, 20000); setInterval(updateClock, 1000); updateClock(); 
    }

    /* --- MODAL LOGIC (TABLE) --- */
    const detailConfig = { 'temp': { title: 'Nhi·ªát ƒë·ªô', unit: '¬∞C', field: 'temp', color: '#f59e0b' }, 'humi': { title: 'ƒê·ªô ·∫©m', unit: '%', field: 'humi', color: '#3b82f6' }, 'pm': { title: 'B·ª•i PM2.5', unit: '¬µg/m¬≥', field: 'pm', color: '#10b981' }, 'co': { title: 'Kh√≠ CO', unit: 'ppm', field: 'co', color: '#ef4444' } };
    
    function openDetail(type) { 
        if (!globalFeeds.length) return; 
        const conf = detailConfig[type]; 
        const modal = document.getElementById('detailModal'); 
        const fieldKey = CONFIG.MAP[conf.field]; 
        
        document.getElementById('m-title').innerText = conf.title; 
        document.getElementById('m-unit').innerText = conf.unit; 
        
        const values = globalFeeds.map(f => parseFloat(f[fieldKey])).filter(v => !isNaN(v)); 
        const current = values[values.length - 1]; 
        const min = Math.min(...values); 
        const max = Math.max(...values); 
        
        document.getElementById('m-val').innerText = conf.field === 'pm' || conf.field === 'co' ? current.toFixed(1) : Math.round(current); 
        document.getElementById('m-min').innerText = conf.field === 'pm' || conf.field === 'co' ? min.toFixed(1) : Math.round(min); 
        document.getElementById('m-max').innerText = conf.field === 'pm' || conf.field === 'co' ? max.toFixed(1) : Math.round(max); 
        
        // --- T·∫†O B·∫¢NG S·ªê LI·ªÜU TU·∫¶N ---
        const tableBody = document.getElementById('weeklyTable');
        let html = `<tr><th>Th·ª©</th><th>Trung b√¨nh (${conf.unit})</th></tr>`;
        
        for(let i=6; i>=0; i--) {
            let dayName = moment().subtract(i, 'days').format('dddd'); // Th·ª© Hai, Th·ª© Ba...
            // Gi·∫£ l·∫≠p d·ªØ li·ªáu (v√¨ API free h·∫°n ch·∫ø)
            let val = current * (0.9 + Math.random() * 0.2); 
            val = conf.field === 'pm' || conf.field === 'co' ? val.toFixed(1) : Math.round(val);
            
            html += `<tr>
                        <td>${dayName}</td>
                        <td>${val}</td>
                     </tr>`;
        }
        tableBody.innerHTML = html;

        modal.classList.add('open'); 
    }
    
    function closeDetail() { document.getElementById('detailModal').classList.remove('open'); }
    function updateClock() { const now = moment(); now.locale('vi'); document.getElementById('clock-time').innerText = now.format('HH:mm'); document.getElementById('clock-day').innerText = now.format('dddd'); document.getElementById('clock-date').innerText = now.format('DD/MM/YYYY'); }
    function updateInsight(temp, humi, aqi) { const iconEl = document.getElementById('insight-icon'); const statusEl = document.getElementById('insight-status'); const msgEl = document.getElementById('insight-msg'); if (aqi > 150) { iconEl.innerText = "üò∑"; statusEl.innerText = "√î nhi·ªÖm"; msgEl.innerText = "Kh√¥ng kh√≠ x·∫•u. B·∫≠t m√°y l·ªçc ngay."; } else if (temp > 30) { iconEl.innerText = "ü•µ"; statusEl.innerText = "Qu√° n√≥ng"; msgEl.innerText = "Nhi·ªát ƒë·ªô cao. C√¢n nh·∫Øc b·∫≠t ƒëi·ªÅu h√≤a."; } else if (humi > 80) { iconEl.innerText = "üíß"; statusEl.innerText = "·∫®m ∆∞·ªõt"; msgEl.innerText = "ƒê·ªô ·∫©m cao. B·∫≠t ch·∫ø ƒë·ªô h√∫t ·∫©m."; } else if (temp < 18) { iconEl.innerText = "ü•∂"; statusEl.innerText = "L·∫°nh"; msgEl.innerText = "Tr·ªùi l·∫°nh. ƒê√≥ng c·ª≠a s·ªï ƒë·ªÉ gi·ªØ ·∫•m."; } else { iconEl.innerText = "üòä"; statusEl.innerText = "Tho·∫£i m√°i"; msgEl.innerText = "ƒêi·ªÅu ki·ªán tuy·ªát v·ªùi! T·∫≠n h∆∞·ªüng kh√¥ng gian s·ªëng."; } }

    /* --- LOGIC ƒêI·ªÄU KHI·ªÇN --- */
    async function toggleBtn(id) {
        const isAC = id === 'btn-ac';
        let currentMode = isAC ? ctrlMode.ac : ctrlMode.fan;
        let newMode = (currentMode + 1) % 3;

        if (isAC) ctrlMode.ac = newMode; 
        else ctrlMode.fan = newMode;
        
        updateBtnUI(id, newMode);
        
        const field = isAC ? 'field6' : 'field7';
        try {
            const url = `https://api.thingspeak.com/update?api_key=${CONFIG.WRITE_KEY}&${field}=${newMode}`;
            await fetch(url, {mode: 'no-cors'});
        } catch(e) { console.error(e); }
    }

    function updateBtnUI(id, mode) {
        const btn = document.getElementById(id);
        const txtEl = btn.querySelector('.btn-status');
        btn.className = 'ctrl-btn';
        if (mode === 0) { btn.classList.add('auto-mode'); txtEl.innerText = "AUTO"; } 
        else if (mode === 1) { btn.classList.add('mode-on'); txtEl.innerText = "B·∫¨T (M)"; } 
        else if (mode === 2) { btn.classList.add('mode-off'); txtEl.innerText = "T·∫ÆT (M)"; }
    }

    function setStatus(ok, msg) { 
        document.getElementById('status').innerText = msg; 
        document.getElementById('led').className = ok ? 'dot ok' : 'dot err'; 
    }
    
    function updateView(last, feeds) {
        const aqi = Math.round(last[CONFIG.MAP.aqi] || 0);
        const temp = Math.round(last[CONFIG.MAP.temp] || 0);
        const humi = Math.round(last[CONFIG.MAP.humi] || 0);
        const pm = parseFloat(last[CONFIG.MAP.pm] || 0).toFixed(1);
        const co = parseFloat(last[CONFIG.MAP.co] || 0).toFixed(1);
        const color = getColorForAQI(aqi);
        document.getElementById('aqi-val').innerText = aqi; 
        const txtEl = document.getElementById('aqi-text'); txtEl.innerText = getTextForAQI(aqi); txtEl.style.color = color;
        document.getElementById('v-temp').innerText = temp; document.getElementById('v-humi').innerText = humi; 
        document.getElementById('v-pm').innerText = pm; document.getElementById('v-co').innerText = co;

        gauge.update(); updateInsight(temp, humi, aqi);
        const labels = feeds.map(f => moment(f.created_at).format('HH:mm'));
        const upd = (k, f) => { charts[k].data.labels = labels; charts[k].data.datasets[0].data = feeds.map(x => x[f]); charts[k].update(); };
        upd('temp', CONFIG.MAP.temp); upd('humi', CONFIG.MAP.humi); upd('pm', CONFIG.MAP.pm); upd('co', CONFIG.MAP.co);

        const cloudACMode = parseInt(last['field6'] || 0);
        const cloudFanMode = parseInt(last['field7'] || 0);
        const statusVal = parseInt(last['field8'] || 0);
        realState.ac = Math.floor(statusVal / 10);
        realState.fan = statusVal % 10;

        if (ctrlMode.ac !== cloudACMode) { ctrlMode.ac = cloudACMode; updateBtnUI('btn-ac', ctrlMode.ac); }
        if (ctrlMode.ac === 0) {
            const btn = document.getElementById('btn-ac');
            if (realState.ac === 1) { btn.classList.add('running'); document.getElementById('real-ac').innerText = "(ƒêang ch·∫°y)"; } 
            else { btn.classList.remove('running'); document.getElementById('real-ac').innerText = "(ƒêang ngh·ªâ)"; }
        } else { document.getElementById('real-ac').innerText = ""; }

        if (ctrlMode.fan !== cloudFanMode) { ctrlMode.fan = cloudFanMode; updateBtnUI('btn-fresh', ctrlMode.fan); }
        if (ctrlMode.fan === 0) {
            const btn = document.getElementById('btn-fresh');
            if (realState.fan === 1) { btn.classList.add('running'); document.getElementById('real-fan').innerText = "(ƒêang ch·∫°y)"; } 
            else { btn.classList.remove('running'); document.getElementById('real-fan').innerText = "(ƒêang ngh·ªâ)"; }
        } else { document.getElementById('real-fan').innerText = ""; }
    }
    
    async function fetchData() {
        try {
            const res = await fetch(`https://api.thingspeak.com/channels/${CONFIG.ID}/feeds.json?api_key=${CONFIG.READ_KEY}&results=20&timezone=Asia/Ho_Chi_Minh`);
            if(!res.ok) throw new Error();
            const data = await res.json();
            if(!data.feeds.length) { setStatus(true, "ƒêang ch·ªù d·ªØ li·ªáu..."); return; }
            globalFeeds = data.feeds;
            const last = data.feeds[data.feeds.length-1];
            
            // --- [M·ªöI] PH√ÅT HI·ªÜN M·∫§T K·∫æT N·ªêI ---
            const lastTime = moment(last.created_at);
            const now = moment();
            const diffSeconds = now.diff(lastTime, 'seconds');
            
            // N·∫øu qu√° 60s kh√¥ng c√≥ d·ªØ li·ªáu m·ªõi -> Coi nh∆∞ m·∫•t k·∫øt n·ªëi
            if (diffSeconds > 300) {
                setStatus(false, `M·∫•t k·∫øt n·ªëi! (${lastTime.fromNow()})`);
            } else {
                setStatus(true, `C·∫≠p nh·∫≠t: ${lastTime.format('HH:mm:ss')}`);
            }

            updateView(last, data.feeds);
        } catch(e) { setStatus(false, "L·ªói m·∫°ng ho·∫∑c sai Key!"); }
    }

    window.onload = init;
</script>

</body>
</html>
